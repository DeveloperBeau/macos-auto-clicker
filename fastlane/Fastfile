default_platform(:mac)

# https://docs.fastlane.tools/actions/build_mac_app/#automating-the-whole-process
platform :mac do
  lane :local do
    desc "Build the release a local version of the Auto Clicker app"

    # https://docs.fastlane.tools/actions/build_mac_app/#parameters
    gym(
      scheme: "auto-clicker",
      workspace: "auto-clicker.xcworkspace",
      clean: true,
      output_directory: "build",
      output_name: "AutoClicker",
      export_method: "mac-application"
    )

    # https://github.com/advoryanskiy/fastlane-plugin-dmg
    dmg(path: "../macos-auto-clicker/build/AutoClicker.app",
        output_path: "../build/AutoClicker.dmg",
        volume_name: "AutoClicker",
        filesystem: "hfs+",
        format: "udzo",
        create_applications_symlink: true,
        size: 10)
  end

  lane :beta do
    desc "Build the release a beta version of the Auto Clicker app"

    # https://docs.fastlane.tools/actions/xcode_select/#xcode_select
    # https://github.com/actions/runner-images/blob/macos-13/20230611.2/images/macos/macos-13-Readme.md#xcode
    xcode_select "/Applications/Xcode_14.3.1.app"

    # http://docs.fastlane.tools/plugins/available-plugins/#semantic_release
    # https://github.com/xotahal/fastlane-plugin-semantic_release
    isReleasable = analyze_commits(
      match: 'beta*'
    )

    # https://docs.fastlane.tools/plugins/available-plugins/#versioning
    # https://github.com/SiarheiFedartsou/fastlane-plugin-versioning
    increment_version_number_in_xcodeproj(
      version_number: "v#{lane_context[SharedValues::RELEASE_NEXT_VERSION]}-beta-#{lane_context[SharedValues::RELEASE_LAST_TAG_HASH]}"
    )

    # https://docs.fastlane.tools/actions/build_mac_app/#parameters
    gym(
      scheme: "auto-clicker",
      workspace: "auto-clicker.xcworkspace",
      clean: true,
      output_directory: "build",
      output_name: "AutoClicker",
      export_method: "mac-application"
    )

    # https://docs.fastlane.tools/actions/commit_version_bump/
    commit_version_bump(
      message: "chore: Fastlane automated version bump (beta)",
      xcodeproj: "auto-clicker.xcodeproj",
      include: %w[Gemfile.lock]
    )

    # https://docs.fastlane.tools/actions/push_to_git_remote/#push_to_git_remote
    push_to_git_remote

    if isReleasable
      # https://docs.fastlane.tools/actions/add_git_tag/#add_git_tag
      add_git_tag(
        tag: "beta/v#{lane_context[SharedValues::RELEASE_NEXT_VERSION]}/#{lane_context[SharedValues::RELEASE_LAST_TAG_HASH]}"
      )

      # https://docs.fastlane.tools/actions/push_to_git_remote/#push_to_git_remote
      push_to_git_remote

      # http://docs.fastlane.tools/plugins/available-plugins/#semantic_release
      # https://github.com/xotahal/fastlane-plugin-semantic_release
      notes = conventional_changelog(
        format: 'markdown',
        title: 'macOS Auto Clicker',
        display_title: false,
        commit_url: 'https://github.com/othyn/macos-auto-clicker/commit',
        sections: {
          feat: ":star2: Features",
          fix: ":bug: Bug Fixes",
          refactor: ":recycle: Code Refactoring",
          perf: ":rocket: Performance Improvements",
          chore: ":wrench: Chores",
          test: ":vertical_traffic_light: Testing",
          docs: ":book: Documentation",
          no_type: ":ghost: Unknown... spooky!"
        }
      )

      # https://github.com/advoryanskiy/fastlane-plugin-dmg
      dmg(path: "../macos-auto-clicker/build/AutoClicker.app",
          output_path: "../build/AutoClicker.dmg",
          volume_name: "AutoClicker",
          filesystem: "hfs+",
          format: "udzo",
          create_applications_symlink: true,
          size: 10)

      # https://docs.fastlane.tools/actions/set_github_release/#set_github_release
      set_github_release(
        repository_name: "othyn/macos-auto-clicker",
        api_bearer: ENV["GITHUB_TOKEN"],
        name: "Beta Release #{lane_context[SharedValues::RELEASE_NEXT_VERSION]} (#{lane_context[SharedValues::RELEASE_LAST_TAG_HASH]})",
        tag_name: "beta/v#{lane_context[SharedValues::RELEASE_NEXT_VERSION]}/#{lane_context[SharedValues::RELEASE_LAST_TAG_HASH]}",
        description: notes,
        is_prerelease: true,
        commitish: "main",
        upload_assets: [
          "build/AutoClicker.dmg",
          "build/AutoClicker.app.dSYM.zip"
        ]
      )
    else
      print("Not flagged as a release candiate, doing nothing.")
    end
  end

  lane :release do
    desc "Build the release a production version of the Auto Clicker app"

    # https://docs.fastlane.tools/actions/xcode_select/#xcode_select
    # https://github.com/actions/runner-images/blob/macos-13/20230611.2/images/macos/macos-13-Readme.md#xcode
    xcode_select "/Applications/Xcode_14.3.1.app"

    # http://docs.fastlane.tools/plugins/available-plugins/#semantic_release
    # https://github.com/xotahal/fastlane-plugin-semantic_release
    isReleasable = analyze_commits(
      match: 'v*'
    )

    # https://docs.fastlane.tools/plugins/available-plugins/#versioning
    # https://github.com/SiarheiFedartsou/fastlane-plugin-versioning
    increment_version_number_in_xcodeproj(
      version_number: lane_context[SharedValues::RELEASE_NEXT_VERSION] # Automatically increment minor version number
    )

    # https://docs.fastlane.tools/actions/build_mac_app/#parameters
    gym(
      scheme: "auto-clicker",
      workspace: "auto-clicker.xcworkspace",
      clean: true,
      output_directory: "build",
      output_name: "AutoClicker",
      export_method: "mac-application"
    )

    # https://github.com/jonathanneilritchie/fastlane-plugin-find_replace_string
    find_replace_string(
      path_to_file: "README.md",
      old_string: "#{lane_context[SharedValues::RELEASE_LAST_VERSION]}",
      new_string: "#{lane_context[SharedValues::RELEASE_NEXT_VERSION]}",
    )

    # https://docs.fastlane.tools/actions/commit_version_bump/
    commit_version_bump(
      message: "chore: Fastlane automated version bump",
      xcodeproj: "auto-clicker.xcodeproj",
      include: %w[Gemfile.lock README.md]
    )

    # https://docs.fastlane.tools/actions/push_to_git_remote/#push_to_git_remote
    push_to_git_remote

    if isReleasable
      # https://docs.fastlane.tools/actions/add_git_tag/#add_git_tag
      add_git_tag(
        tag: "v#{lane_context[SharedValues::RELEASE_NEXT_VERSION]}"
      )

      # https://docs.fastlane.tools/actions/push_to_git_remote/#push_to_git_remote
      push_to_git_remote

      # http://docs.fastlane.tools/plugins/available-plugins/#semantic_release
      # https://github.com/xotahal/fastlane-plugin-semantic_release
      notes = conventional_changelog(
        format: 'markdown',
        title: 'macOS Auto Clicker',
        display_title: false,
        commit_url: 'https://github.com/othyn/macos-auto-clicker/commit',
        sections: {
          feat: ":star2: Features",
          fix: ":bug: Bug Fixes",
          refactor: ":recycle: Code Refactoring",
          perf: ":rocket: Performance Improvements",
          chore: ":wrench: Chores",
          test: ":vertical_traffic_light: Testing",
          docs: ":book: Documentation",
          no_type: ":ghost: Unknown... spooky!"
        }
      )

      # https://github.com/advoryanskiy/fastlane-plugin-dmg
      dmg(path: "../macos-auto-clicker/build/AutoClicker.app",
          output_path: "../build/AutoClicker.dmg",
          volume_name: "AutoClicker",
          filesystem: "hfs+",
          format: "udzo",
          create_applications_symlink: true,
          size: 10)

      # https://docs.fastlane.tools/actions/set_github_release/#set_github_release
      set_github_release(
        repository_name: "othyn/macos-auto-clicker",
        api_bearer: ENV["GITHUB_TOKEN"],
        name: "Release #{lane_context[SharedValues::RELEASE_NEXT_VERSION]}",
        tag_name: "v#{lane_context[SharedValues::RELEASE_NEXT_VERSION]}",
        description: notes,
        commitish: "main",
        upload_assets: [
          "build/AutoClicker.dmg",
          "build/AutoClicker.app.dSYM.zip"
        ]
      )
    else
      print("Not flagged as a release candiate, doing nothing.")
    end
  end
end
